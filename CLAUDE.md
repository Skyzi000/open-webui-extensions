# Claude開発メモ

## Universal File Generator 開発記録

### 重要な学習事項・課題解決記録

#### 1. ZIP内バイナリファイル自動変換機能 (重要)
**問題**: ZIP作成時に `{"sample.docx": "# Markdown text"}` のような入力で、Markdownテキストがそのまま.docxファイル名で保存されてしまい、有効なDOCXファイルにならない

**解決**: 
- ファイル拡張子（.docx, .pdf, .xlsx）を検出して自動でバイナリ変換
- FileGeneratorを使ってテキスト内容を適切な形式に変換
- ~~変換失敗時は.txtファイルとしてフォールバック~~ → **削除済み（v0.20.2-pandoc）**

**実装場所**: `_add_files_to_zip()` 関数内
- 元ファイル: 既に対応済み (List形式→Dict形式変換後にFileGenerator使用)
- Pandoc版: 新たに実装

**注意**: 新しいバージョンを作る時は、この機能を最初から組み込むこと

#### 2. SVG画像のDOCX埋め込み対応
**問題**: SVGファイルがDOCXに直接埋め込めない

**解決**: 
- CairoSVGでSVG→PNG変換
- HTMLエスケープ文字の自動解除
- インラインSVG（`<svg>`タグ）とimg要素の両対応

**実装**: v0.20.0で対応完了

#### 3. 日本語フォント問題
**PDF生成で日本語が表示されない問題**

**解決策の変遷**:
1. 最初: フォント自動ダウンロード機能実装
2. システム環境整備後: システムフォント使用に変更
   - `texlive-lang-japanese`
   - `fonts-noto-cjk`

**Pandoc版**: XeLaTeX + システム日本語フォント使用

#### 4. データ形式の明確化
**問題**: DOCX/PDF生成時にJSON/Dictオブジェクトが渡されて期待通りに動作しない

**解決**: 
- 関数説明にSTRING形式推奨の警告を追加
- 複雑なDict構造の入力エラーチェック実装

### 開発方針・ルール

1. **新バージョン作成時の注意**:
   - 既存の課題解決機能を忘れずに組み込む
   - このCLAUDE.mdの内容を参照して漏れを防ぐ

2. **重要な機能**:
   - ZIP内自動バイナリ変換は必須機能
   - SVG→PNG変換（DOCX用）
   - 日本語フォント対応

3. **エラーハンドリング方針** (v0.20.2-pandoc～):
   - **安易なフォールバック機能は実装しない**
   - エラー発生時は適切なエラーメッセージと共に例外を発生させる
   - AIが問題を理解して対処できるよう、具体的で建設的なエラー情報を提供する
   - 無駄な手数を増やすだけの.txtフォールバックなどは禁止

4. **AI向けドキュメント方針** (重要):
   - **使用者はAI、実行環境はDocker上のOpenWebUI**
   - AIはToolsクラスのメソッドドキュメントと戻り値しか見えない
   - 全ての重要情報をToolsクラスのdocstringに含める必要がある
   - 内部実装クラス（FileGenerator等）のドキュメントは参考程度
   - Field descriptionでデータ形式要件を明確に記載
   - CRITICALな情報は強調表示で記載

5. **テスト項目**:
   - `{"sample.docx": "# Test"}` → 有効なDOCXファイル生成
   - SVG画像のDOCX埋め込み
   - 日本語テキストのPDF生成

### アーキテクチャ比較

#### オリジナル版 (v0.20.0)
- 詳細なHTML解析とSVG→PNG変換
- フォント自動ダウンロード→システムフォント使用
- CairoSVG, BeautifulSoup使用

#### Pandoc版 (v0.20.0-pandoc)
- Pandocによるシンプルな変換
- XeLaTeX + システム日本語フォント
- ネイティブSVG対応（pandoc処理）

### 今後の課題

1. **メモリ効率**: 大きなファイル処理時の最適化
2. **エラーハンドリング**: より詳細なエラー情報
3. **テスト自動化**: 重要機能の回帰テスト

---
*このファイルは開発過程で学んだ重要事項を記録し、同じ課題を繰り返さないために維持される*